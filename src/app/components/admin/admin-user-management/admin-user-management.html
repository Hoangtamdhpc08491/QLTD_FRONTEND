<div class="admin-user-management">
  <!-- Header -->
  <div class="page-header">
    <h1>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="createUser()">
        ‚ûï Th√™m ng∆∞·ªùi d√πng
      </button>
      <button class="btn btn-outline" (click)="exportToExcel()">
        üìä Xu·∫•t Excel
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <input type="text" 
             [(ngModel)]="searchTerm" 
             (ngModelChange)="applyFilters()"
             placeholder="T√¨m ki·∫øm theo t√™n, email, SƒêT..."
             class="search-input">
      <span class="search-icon">üîç</span>
    </div>

    <div class="filter-controls">
      <select [(ngModel)]="statusFilter" 
              (ngModelChange)="applyFilters()"
              class="filter-select">
        <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="Ho·∫°t ƒë·ªông">Ho·∫°t ƒë·ªông</option>
        <option value="T·∫°m kh√≥a">T·∫°m kh√≥a</option>
      </select>

      <select [(ngModel)]="creditRatingFilter" 
              (ngModelChange)="applyFilters()"
              class="filter-select">
        <option value="">T·∫•t c·∫£ ƒë√°nh gi√°</option>
        <option value="Xu·∫•t s·∫Øc">Xu·∫•t s·∫Øc</option>
        <option value="T·ªët">T·ªët</option>
        <option value="Trung b√¨nh">Trung b√¨nh</option>
        <option value="M·ªõi">M·ªõi</option>
      </select>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary">
    <p>Hi·ªÉn th·ªã {{getPaginatedUsers().length}} trong t·ªïng s·ªë {{filteredUsers.length}} ng∆∞·ªùi d√πng</p>
  </div>

  <!-- Users Table -->
  <div class="users-table-container">
    <table class="users-table">
      <thead>
        <tr>
          <th>M√£ KH</th>
          <th>Th√¥ng tin c√° nh√¢n</th>
          <th>Li√™n h·ªá</th>
          <th>Ngh·ªÅ nghi·ªáp</th>
          <th>L·ªãch s·ª≠ vay</th>
          <th>ƒê√°nh gi√° t√≠n d·ª•ng</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of getPaginatedUsers()" class="user-row">
          <td class="user-id">
            <strong>{{user.id}}</strong>
            <div class="register-date">
              <small>{{user.ngayDangKy | date:'dd/MM/yyyy'}}</small>
            </div>
          </td>
          
          <td class="user-info">
            <div class="user-details">
              <div class="user-name">{{user.hoTen}}</div>
              <div class="user-personal">
                <small>{{user.gioiTinh}} ‚Ä¢ {{user.tinhTrangHonNhan}}</small><br>
                <small>SN: {{user.ngaySinh | date:'dd/MM/yyyy'}}</small>
              </div>
            </div>
          </td>

          <td class="contact-info">
            <div class="contact-details">
              <div class="email">{{user.email}}</div>
              <div class="phone">{{user.soDienThoai}}</div>
              <small class="address">{{user.diaChi}}</small>
            </div>
          </td>

          <td class="job-info">
            <div class="job-details">
              <div class="occupation">{{user.ngheNghiep}}</div>
              <div class="income">{{formatCurrency(user.thuNhapHangThang)}}</div>
            </div>
          </td>

          <td class="loan-history">
            <div class="loan-stats">
              <div class="loan-count">{{user.soLanVay}} l·∫ßn vay</div>
              <div class="loan-amount">{{formatCurrency(user.tongTienDaVay)}}</div>
              <button class="btn btn-xs btn-link" 
                      *ngIf="user.soLanVay > 0"
                      (click)="viewUserApplications(user.id)">
                Xem chi ti·∫øt
              </button>
            </div>
          </td>

          <td class="credit-rating">
            <span class="credit-badge" [class]="getCreditRatingClass(user.danhGiaTinDung)">
              {{user.danhGiaTinDung}}
            </span>
          </td>

          <td class="status-cell">
            <span class="status-badge" [class]="getStatusClass(user.trangThai)">
              {{user.trangThai}}
            </span>
            <div class="last-login" *ngIf="user.lanDangNhapCuoi">
              <small>{{user.lanDangNhapCuoi | date:'dd/MM/yyyy'}}</small>
            </div>
          </td>

          <td class="actions-cell">
            <div class="action-buttons">
              <button class="btn btn-xs btn-outline" (click)="viewUser(user)">
                üëÅÔ∏è Xem
              </button>
              <button class="btn btn-xs btn-primary" (click)="editUser(user)">
                ‚úèÔ∏è S·ª≠a
              </button>
              <button class="btn btn-xs" 
                      [class]="user.trangThai === 'Ho·∫°t ƒë·ªông' ? 'btn-warning' : 'btn-success'"
                      (click)="toggleUserStatus(user)">
                <span *ngIf="user.trangThai === 'Ho·∫°t ƒë·ªông'">üîí</span>
                <span *ngIf="user.trangThai !== 'Ho·∫°t ƒë·ªông'">üîì</span>
              </button>
              <button class="btn btn-xs btn-danger" (click)="deleteUser(user)">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="getPaginatedUsers().length === 0">
      <div class="empty-icon">üë•</div>
      <h3>Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o</h3>
      <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·ª´ kh√≥a t√¨m ki·∫øm</p>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button class="pagination-btn" 
            [disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)">
      ‚Äπ Tr∆∞·ªõc
    </button>

    <span class="pagination-info">
      Trang {{currentPage}} / {{totalPages}}
    </span>

    <button class="pagination-btn" 
            [disabled]="currentPage === totalPages"
            (click)="goToPage(currentPage + 1)">
      Sau ‚Ä∫
    </button>
  </div>
</div>

<!-- User Modal -->
<div class="modal-overlay" *ngIf="showUserModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <span *ngIf="modalMode === 'view'">Chi ti·∫øt ng∆∞·ªùi d√πng</span>
        <span *ngIf="modalMode === 'edit'">Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng</span>
        <span *ngIf="modalMode === 'create'">Th√™m ng∆∞·ªùi d√πng m·ªõi</span>
      </h2>
      <button class="modal-close" (click)="closeModal()">‚úï</button>
    </div>

    <div class="modal-body" *ngIf="selectedUser">
      <form class="user-form">
        <div class="form-grid">
          <div class="form-group">
            <label>H·ªç v√† t√™n</label>
            <input type="text" 
                   [(ngModel)]="selectedUser.hoTen" 
                   name="hoTen"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input type="email" 
                   [(ngModel)]="selectedUser.email" 
                   name="email"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" 
                   [(ngModel)]="selectedUser.soDienThoai" 
                   name="soDienThoai"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group">
            <label>CMND/CCCD</label>
            <input type="text" 
                   [(ngModel)]="selectedUser.cmnd" 
                   name="cmnd"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group full-width">
            <label>ƒê·ªãa ch·ªâ</label>
            <input type="text" 
                   [(ngModel)]="selectedUser.diaChi" 
                   name="diaChi"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group">
            <label>Ng√†y sinh</label>
            <input type="date" 
                   [value]="selectedUser.ngaySinh | date:'yyyy-MM-dd'"
                   (input)="updateBirthDate($event)"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group">
            <label>Gi·ªõi t√≠nh</label>
            <select [(ngModel)]="selectedUser.gioiTinh" 
                    name="gioiTinh"
                    [disabled]="modalMode === 'view'"
                    class="form-control">
              <option value="Nam">Nam</option>
              <option value="N·ªØ">N·ªØ</option>
            </select>
          </div>

          <div class="form-group">
            <label>Ngh·ªÅ nghi·ªáp</label>
            <input type="text" 
                   [(ngModel)]="selectedUser.ngheNghiep" 
                   name="ngheNghiep"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group">
            <label>Thu nh·∫≠p h√†ng th√°ng</label>
            <input type="number" 
                   [(ngModel)]="selectedUser.thuNhapHangThang" 
                   name="thuNhapHangThang"
                   [readonly]="modalMode === 'view'"
                   class="form-control">
          </div>

          <div class="form-group" *ngIf="modalMode !== 'create'">
            <label>Tr·∫°ng th√°i</label>
            <select [(ngModel)]="selectedUser.trangThai" 
                    name="trangThai"
                    [disabled]="modalMode === 'view'"
                    class="form-control">
              <option value="Ho·∫°t ƒë·ªông">Ho·∫°t ƒë·ªông</option>
              <option value="T·∫°m kh√≥a">T·∫°m kh√≥a</option>
            </select>
          </div>

          <div class="form-group" *ngIf="modalMode !== 'create'">
            <label>ƒê√°nh gi√° t√≠n d·ª•ng</label>
            <select [(ngModel)]="selectedUser.danhGiaTinDung" 
                    name="danhGiaTinDung"
                    [disabled]="modalMode === 'view'"
                    class="form-control">
              <option value="M·ªõi">M·ªõi</option>
              <option value="Trung b√¨nh">Trung b√¨nh</option>
              <option value="T·ªët">T·ªët</option>
              <option value="Xu·∫•t s·∫Øc">Xu·∫•t s·∫Øc</option>
            </select>
          </div>
        </div>

        <!-- Statistics for existing users -->
        <div class="user-stats" *ngIf="modalMode !== 'create'">
          <h3>Th·ªëng k√™</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">Ng√†y ƒëƒÉng k√Ω:</span>
              <span class="stat-value">{{selectedUser.ngayDangKy | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi:</span>
              <span class="stat-value">{{selectedUser.lanDangNhapCuoi | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">S·ªë l·∫ßn vay:</span>
              <span class="stat-value">{{selectedUser.soLanVay}} l·∫ßn</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">T·ªïng ti·ªÅn ƒë√£ vay:</span>
              <span class="stat-value">{{formatCurrency(selectedUser.tongTienDaVay)}}</span>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">ƒê√≥ng</button>
      <button class="btn btn-primary" 
              *ngIf="modalMode !== 'view'"
              (click)="saveUser()">
        <span *ngIf="modalMode === 'create'">T·∫°o</span>
        <span *ngIf="modalMode === 'edit'">L∆∞u</span>
      </button>
    </div>
  </div>
</div>
