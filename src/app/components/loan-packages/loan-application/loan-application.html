<app-header></app-header>

<div class="loan-application-page">
  <!-- Progress Header -->
  <section class="progress-header">
    <div class="container">
      <div class="progress-steps">
        <div class="step" 
             *ngFor="let step of [1,2,3,4]; let i = index"
             [class.active]="isCurrentStep(step)"
             [class.completed]="isStepCompleted(step)"
             (click)="goToStep(step)">
          <div class="step-number">{{step}}</div>
          <div class="step-title">{{getStepTitle(step)}}</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
    </div>
  </section>

  <!-- Error Display -->
  <div class="error-container" *ngIf="error">
    <div class="container">
      <div class="alert alert-error">
        {{error}}
        <button type="button" class="close-btn" (click)="error = null">×</button>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Đang tải...</p>
  </div>

  <!-- Main Form -->
  <section class="form-section">
    <div class="container">
      <form #loanForm="ngForm" class="loan-form">
        
        <!-- Step 1: Thông tin gói vay -->
        <div class="form-step" *ngIf="currentStep === 1">
          <div class="step-header">
            <h2>Thông tin gói vay</h2>
            <p>Xem thông tin chi tiết về gói vay bạn đã chọn</p>
          </div>
          
          <div class="package-details" *ngIf="selectedPackage">
            <div class="package-card">
              <div class="package-header">
                <h3>{{selectedPackage.name}}</h3>
                <span class="package-code">Mã: #{{selectedPackage.id}}</span>
              </div>
              
              <div class="package-info">
                <div class="info-row">
                  <span class="label">Lãi suất cơ bản:</span>
                  <span class="value">{{selectedPackage.baseInterestRate}}%/năm</span>
                </div>
                <div class="info-row" *ngIf="selectedPackage.maxAmount">
                  <span class="label">Hạn mức tối đa:</span>
                  <span class="value">{{formatCurrency(selectedPackage.maxAmount)}}</span>
                </div>
                <div class="info-row" *ngIf="selectedPackage.interestRate2">
                  <span class="label">Lãi suất 12-24 tháng:</span>
                  <span class="value">{{selectedPackage.interestRate2}}%/năm</span>
                </div>
                <div class="info-row" *ngIf="selectedPackage.interestRate3">
                  <span class="label">Lãi suất 24-36 tháng:</span>
                  <span class="value">{{selectedPackage.interestRate3}}%/năm</span>
                </div>
              </div>
              
              <div class="package-description">
                <p>{{selectedPackage.description1}}</p>
                <p *ngIf="selectedPackage.description2">{{selectedPackage.description2}}</p>
              </div>
            </div>
          </div>

          <div class="no-package" *ngIf="!selectedPackage && !isLoading">
            <p>Không tìm thấy thông tin gói vay. Vui lòng quay lại trang danh sách để chọn gói vay.</p>
            <a routerLink="/loan-packages" class="btn btn-primary">Chọn gói vay</a>
          </div>
        </div>

        <!-- Step 2: Thông tin cá nhân -->
        <div class="form-step" *ngIf="currentStep === 2">
          <div class="step-header">
            <h2>Thông tin cá nhân</h2>
            <p>Nhập thông tin cá nhân của bạn</p>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="name">Họ và tên *</label>
              <input 
                type="text" 
                id="name"
                name="name"
                [(ngModel)]="application.name"
                required
                class="form-control"
                placeholder="Nhập họ và tên đầy đủ">
            </div>

            <div class="form-group">
              <label for="email">Email *</label>
              <input 
                type="email" 
                id="email"
                name="email"
                [(ngModel)]="application.email"
                required
                class="form-control"
                placeholder="Nhập địa chỉ email">
            </div>

            <div class="form-group">
              <label for="phone">Số điện thoại *</label>
              <input 
                type="tel" 
                id="phone"
                name="phone"
                [(ngModel)]="application.phone"
                required
                class="form-control"
                placeholder="Nhập số điện thoại">
            </div>

            <div class="form-group">
              <label for="birthDay">Ngày sinh *</label>
              <input 
                type="date" 
                id="birthDay"
                name="birthDay"
                [(ngModel)]="application.birthDay"
                required
                class="form-control">
            </div>

            <div class="form-group">
              <label for="gender">Giới tính</label>
              <select 
                id="gender"
                name="gender"
                [(ngModel)]="application.gender"
                class="form-control">
                <option *ngFor="let option of genderOptions" [value]="option.value">
                  {{option.label}}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="maritalStatus">Tình trạng hôn nhân</label>
              <select 
                id="maritalStatus"
                name="maritalStatus"
                [(ngModel)]="application.maritalStatus"
                class="form-control">
                <option *ngFor="let option of maritalOptions" [value]="option.value">
                  {{option.label}}
                </option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="address">Địa chỉ *</label>
              <textarea 
                id="address"
                name="address"
                [(ngModel)]="application.address"
                required
                class="form-control"
                rows="3"
                placeholder="Nhập địa chỉ hiện tại"></textarea>
            </div>

            <div class="form-group">
              <label for="job">Nghề nghiệp *</label>
              <input 
                type="text" 
                id="job"
                name="job"
                [(ngModel)]="application.job"
                required
                class="form-control"
                placeholder="Nhập nghề nghiệp hiện tại">
            </div>

            <div class="form-group">
              <label for="salary">Thu nhập hàng tháng *</label>
              <input 
                type="number" 
                id="salary"
                name="salary"
                [(ngModel)]="application.salary"
                required
                min="0"
                class="form-control"
                placeholder="Nhập thu nhập hàng tháng">
            </div>
          </div>
        </div>

        <!-- Step 3: Thông tin vay -->
        <div class="form-step" *ngIf="currentStep === 3">
          <div class="step-header">
            <h2>Thông tin khoản vay</h2>
            <p>Nhập số tiền và thời hạn vay mong muốn</p>
          </div>
          
          <div class="loan-info-form">
            <div class="form-group">
              <label for="loanAmount">Số tiền vay *</label>
              <input 
                type="number" 
                id="loanAmount"
                name="loanAmount"
                [(ngModel)]="application.loanAmount"
                (ngModelChange)="onLoanAmountChange()"
                required
                min="1000000"
                [max]="selectedPackage?.maxAmount || 0"
                class="form-control"
                placeholder="Nhập số tiền muốn vay">
              <small class="form-text" *ngIf="selectedPackage && selectedPackage.maxAmount">
                Hạn mức tối đa: {{formatCurrency(selectedPackage.maxAmount)}}
              </small>
            </div>

            <div class="form-group">
              <label for="loanTerm">Thời hạn vay *</label>
              <select 
                id="loanTerm"
                name="loanTerm"
                [(ngModel)]="application.loanTerm"
                (ngModelChange)="onLoanTermChange()"
                required
                class="form-control">
                <option *ngFor="let option of loanTermOptions" [value]="option.value">
                  {{option.label}}
                </option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="note">Ghi chú</label>
              <textarea 
                id="note"
                name="note"
                [(ngModel)]="application.note"
                class="form-control"
                rows="3"
                placeholder="Nhập ghi chú nếu có"></textarea>
            </div>

            <!-- Loan Calculation -->
            <div class="loan-calculation" *ngIf="loanCalculation">
              <h3>Thông tin tính toán</h3>
              <div class="calculation-grid">
                <div class="calc-item">
                  <span class="label">Lãi suất áp dụng:</span>
                  <span class="value">{{loanCalculation.interestRate}}%/năm</span>
                </div>
                <div class="calc-item">
                  <span class="label">Số tiền phải trả hàng tháng:</span>
                  <span class="value highlight">{{formatCurrency(loanCalculation.emi)}}</span>
                </div>
                <div class="calc-item">
                  <span class="label">Tổng tiền lãi:</span>
                  <span class="value">{{formatCurrency(loanCalculation.interestAmount)}}</span>
                </div>
                <div class="calc-item">
                  <span class="label">Tổng số tiền phải trả:</span>
                  <span class="value highlight">{{formatCurrency(loanCalculation.totalAmount)}}</span>
                </div>
              </div>
            </div>

            <div class="calculating" *ngIf="isCalculating">
              <div class="spinner-small"></div>
              <span>Đang tính toán...</span>
            </div>
          </div>
        </div>

        <!-- Step 4: Xác nhận -->
        <div class="form-step" *ngIf="currentStep === 4">
          <div class="step-header">
            <h2>Xác nhận thông tin</h2>
            <p>Vui lòng kiểm tra lại thông tin trước khi gửi đơn</p>
          </div>
          
          <div class="confirmation-summary">
            <!-- Thông tin gói vay -->
            <div class="summary-section">
              <h3>Thông tin gói vay</h3>
              <div class="summary-content" *ngIf="selectedPackage">
                <p><strong>Tên gói:</strong> {{selectedPackage.name}}</p>
                <p><strong>Mã gói:</strong> #{{selectedPackage.id}}</p>
              </div>
            </div>

            <!-- Thông tin cá nhân -->
            <div class="summary-section">
              <h3>Thông tin cá nhân</h3>
              <div class="summary-content">
                <p><strong>Họ tên:</strong> {{application.name}}</p>
                <p><strong>Email:</strong> {{application.email}}</p>
                <p><strong>Điện thoại:</strong> {{application.phone}}</p>
                <p><strong>Địa chỉ:</strong> {{application.address}}</p>
                <p><strong>Nghề nghiệp:</strong> {{application.job}}</p>
                <p><strong>Thu nhập:</strong> {{formatCurrency(application.salary)}}/tháng</p>
              </div>
            </div>

            <!-- Thông tin vay -->
            <div class="summary-section">
              <h3>Thông tin khoản vay</h3>
              <div class="summary-content">
                <p><strong>Số tiền vay:</strong> {{formatCurrency(application.loanAmount)}}</p>
                <p><strong>Thời hạn:</strong> {{application.loanTerm}} tháng</p>
                <div *ngIf="loanCalculation">
                  <p><strong>Lãi suất:</strong> {{loanCalculation.interestRate}}%/năm</p>
                  <p><strong>Trả hàng tháng:</strong> {{formatCurrency(loanCalculation.emi)}}</p>
                  <p><strong>Tổng tiền trả:</strong> {{formatCurrency(loanCalculation.totalAmount)}}</p>
                </div>
              </div>
            </div>

            <!-- Terms Agreement -->
            <div class="terms-section">
              <label class="checkbox-label">
                <input type="checkbox" #termsAccepted>
                <span class="checkmark"></span>
                Tôi đã đọc và đồng ý với 
                <a href="#" target="_blank">điều khoản và điều kiện</a> 
                của dịch vụ
              </label>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="form-navigation">
          <button 
            type="button" 
            class="btn btn-secondary"
            *ngIf="currentStep > 1"
            (click)="previousStep()">
            Quay lại
          </button>
          
          <button 
            type="button" 
            class="btn btn-primary"
            *ngIf="currentStep < totalSteps"
            [disabled]="!canProceedToNextStep()"
            (click)="nextStep()">
            Tiếp tục
          </button>
          
          <button 
            type="button" 
            class="btn btn-success"
            *ngIf="currentStep === totalSteps"
            [disabled]="!canSubmit() || isSubmitting"
            (click)="submitApplication()">
            <span *ngIf="isSubmitting">
              <span class="spinner-small"></span>
              Đang gửi...
            </span>
            <span *ngIf="!isSubmitting">
              Gửi đơn vay
            </span>
          </button>
        </div>
      </form>
    </div>
  </section>
</div>

<app-footer></app-footer>
